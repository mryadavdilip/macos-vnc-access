name: macOS VNC Access

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  macos-vnc:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup VNC Server
        run: |
          # Set VNC password
          VNC_PASSWORD="Dilip@2026"
          
          # Enable screen sharing via System Settings
          echo "Enabling screen sharing..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -restart -agent -privs -all
          
          # Configure VNC password using different method
          echo "Configuring VNC password..."
          sudo /usr/bin/dscl . -passwd /Users/runner "$VNC_PASSWORD" 2>/dev/null || true
          
          # Alternative: Use system preferences to enable VNC
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement ARD_AllLocalUsers -bool true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          echo "VNC Server Started"
          echo "Password: $VNC_PASSWORD"
      
      - name: Install ngrok
        run: |
          brew install --cask ngrok
      
      - name: Setup ngrok authtoken
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -z "$NGROK_AUTH_TOKEN" ]; then
            echo "WARNING: No NGROK_AUTH_TOKEN secret set. Using free tier (limited)."
            echo "Sign up at https://ngrok.com and add token to GitHub secrets"
          else
            ngrok authtoken $NGROK_AUTH_TOKEN
          fi
      
      - name: Start ngrok tunnel for VNC
        run: |
          # Start ngrok in background for VNC port 5900
          echo "Starting ngrok tunnel..."
          nohup ngrok tcp 5900 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "ngrok PID: $NGROK_PID"
          
          # Wait for ngrok to start and retry API calls
          echo "Waiting for ngrok API to be ready..."
          for i in {1..30}; do
            sleep 2
            if curl -s http://localhost:4040/api/tunnels > /dev/null 2>&1; then
              echo "ngrok API is ready!"
              break
            fi
            echo "Attempt $i/30 - waiting for ngrok..."
          done
          
          # Get ngrok URL with better parsing
          echo "Fetching tunnel information..."
          sleep 5
          TUNNEL_DATA=$(curl -s http://localhost:4040/api/tunnels)
          echo "Raw tunnel data:"
          echo "$TUNNEL_DATA" | jq '.' || echo "$TUNNEL_DATA"
          
          # Extract the public URL using multiple methods
          NGROK_URL=$(echo "$TUNNEL_DATA" | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "$TUNNEL_DATA" | grep -o 'tcp://[^"]*' | head -1)
          
          if [ -z "$NGROK_URL" ]; then
            echo "ERROR: Failed to get ngrok URL!"
            echo "ngrok log:"
            cat ngrok.log
            exit 1
          fi
          
          echo ""
          echo "============================================"
          echo "VNC ACCESS DETAILS"
          echo "============================================"
          echo "VNC URL: $NGROK_URL"
          echo "Password: Dilip@2026"
          echo "Username: runner"
          echo ""
          echo "To connect from Windows:"
          echo "1. Download VNC Viewer: https://www.realvnc.com/download/viewer/"
          echo "2. Connect to: $NGROK_URL"
          echo "3. Use password: Dilip@2026"
          echo "============================================"
          echo ""
          
          # Save to file
          echo "$NGROK_URL" > vnc-url.txt
          echo "Dilip@2026" > vnc-password.txt
          
          # Verify ngrok is still running
          if ps -p $NGROK_PID > /dev/null; then
            echo "ngrok is running (PID: $NGROK_PID)"
          else
            echo "WARNING: ngrok process died!"
          fi
      
      - name: Keep session alive
        run: |
          echo "VNC session is active. Connection details above."
          echo "This session will stay alive for 6 hours (GitHub Actions limit)"
          echo "Press 'Cancel workflow' button to stop early."
          echo ""
          
          # Keep alive for 6 hours (max GitHub Actions time)
          for i in {1..360}; do
            echo "Session active - Minute $i/360"
            sleep 60
          done
      
      - name: Upload connection details
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vnc-connection-details
          path: |
            vnc-url.txt
            vnc-password.txt
            ngrok.log
